## å‰è¨€

> å“ˆå–½ï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯`asong`ã€‚ç»ˆäºå›å½’äº†ï¼Œåœæ›´äº†ä¸¤å‘¨äº†ï¼Œè¿™ä¸¤å‘¨ä¸€ç›´åœ¨æç•™è¨€å·çš„äº‹ï¼Œç»è¿‡æ¼«é•¿çš„ç­‰å¾…ï¼Œç»ˆäºæå®šäº†ã€‚å…„å¼Ÿä»¬ï¼Œä»¥åå°±å¯ä»¥åœ¨ç•™è¨€åŒºå°½æƒ…å¼€å–·äº†ï¼Œåªè¦ä½ æ•¢å–·ï¼Œæˆ‘å°±æ•¢ç²¾é€‰ğŸ¶ã€‚(å› ä¸ºå‘ç”Ÿäº†è´¦å·è¿ç§»ï¼Œéœ€ç‚¹å‡»å³ä¸Šè§’é‡æ–°æ·»åŠ æ˜Ÿæ ‡ï¼Œä¼˜è´¨æ–‡ç« ç¬¬ä¸€æ—¶é—´è·å–ï¼)
>
> ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„æ˜¯`Go`è¯­è¨€ä¸­çš„`channel`ã€‚`Go`è¯­è¨€ä»å‡ºä¸–ä»¥æ¥å°±ä»¥é«˜å¹¶å‘è‘—ç§°ï¼Œå¾—ç›Šäºå…¶`Goroutine`çš„è®¾è®¡ï¼Œ`Goroutine`ä¹Ÿå°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„è½»é‡çº§åç¨‹ï¼Œæœ‰äº†`Goroutine`æˆ‘ä»¬å¯ä»¥è½»æ¾çš„è¿è¡Œåç¨‹ï¼Œä½†è¿™å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¾€å¾€è¿˜å¸Œæœ›å¤šä¸ªçº¿ç¨‹/åç¨‹æ˜¯èƒ½å¤Ÿé€šä¿¡çš„ï¼Œ`Go`è¯­è¨€ä¸ºäº†æ”¯æŒå¤šä¸ª`Goroutine`é€šä¿¡ï¼Œè®¾è®¡äº†`channel`ï¼Œæœ¬æ–‡æˆ‘ä»¬å°±ä¸€èµ·ä»`GO1.15`çš„æºç å‡ºå‘ï¼Œçœ‹çœ‹`channel`åˆ°åº•æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚
>
> å¥½å•¦ï¼Œå¼€å¾€å¹¼å„¿å›­çš„åˆ—è½¦å°±è¦å¼€äº†ï¼Œæœ‹å‹ä»¬ç³»å¥½å®‰å…¨å¸¦ï¼Œæˆ‘è¦å¼€è½¦å•¦ğŸ¶



## ä»€ä¹ˆæ˜¯channel

é€šè¿‡å¼€å¤´çš„ä»‹ç»æˆ‘ä»¬å¯ä»¥çŸ¥é“`channel`æ˜¯ç”¨äº`goroutine`çš„æ•°æ®é€šä¿¡ï¼Œåœ¨`Go`ä¸­é€šè¿‡`goroutine+channel`çš„æ–¹å¼ï¼Œå¯ä»¥ç®€å•ã€é«˜æ•ˆåœ°è§£å†³å¹¶å‘é—®é¢˜ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ç®€å•çš„ç¤ºä¾‹ï¼š

```go
func GoroutineOne(ch chan <-string)  {
	fmt.Println("GoroutineOne running")
	ch <- "asongçœŸå¸…"
	fmt.Println("GoroutineOne end of the run")
}

func GoroutineTwo(ch <- chan string)  {
	fmt.Println("GoroutineTwo running")
	fmt.Printf("å¥³æœ‹å‹è¯´ï¼š%s\n",<-ch)
	fmt.Println("GoroutineTwo end of the run")
}


func main()  {
	ch := make(chan string)
	go GoroutineOne(ch)
	go GoroutineTwo(ch)
	time.Sleep(3 * time.Second)
}
// è¿è¡Œç»“æœ
// GoroutineOne running
// GoroutineTwo running
// å¥³æœ‹å‹è¯´ï¼šasongçœŸå¸…
// GoroutineTwo end of the run
// GoroutineOne end of the run
```

è¿™é‡Œæˆ‘ä»¬è¿è¡Œäº†ä¸¤ä¸ª`Goroutine`ï¼Œåœ¨`GoroutineOne`ä¸­æˆ‘ä»¬å‘`channel`ä¸­å†™å…¥æ•°æ®ï¼Œåœ¨`GoroutineTwo`ä¸­æˆ‘ä»¬ç›‘å¬`channel`ï¼Œç›´åˆ°è¯»å–åˆ°"asongçœŸå¸…"ã€‚æˆ‘ä»¬å¯ä»¥ç”»ä¸€ä¸ªç®€å•çš„å›¾æ¥è¡¨æ˜ä¸€ä¸‹è¿™ä¸ªé¡ºåºï¼š

![](https://song-oss.oss-cn-beijing.aliyuncs.com/golang_dream/article/static/%E6%88%AA%E5%B1%8F2021-06-25%20%E4%B8%8B%E5%8D%883.28.05.png)

ä¸Šé¢çš„ä¾‹å­æ˜¯å¯¹æ— ç¼“å†²`channel`çš„ä¸€ä¸ªç®€å•åº”ç”¨ï¼Œå…¶å®`channel`çš„ä½¿ç”¨è¯­æ³•è¿˜æ˜¯æŒºå¤šçš„ï¼Œä¸‹é¢ä¸”å¬æˆ‘æ…¢æ…¢é“æ¥ï¼Œæ¯•ç«Ÿæ˜¯ä»å…¥é—¨åˆ°æ”¾å¼ƒå˜›ï¼Œé‚£å°±å…ˆä»å…¥é—¨å¼€å§‹ã€‚



## å…¥é—¨`channel`

### `channel`ç±»å‹

`channel`æœ‰ä¸‰ç§ç±»å‹çš„å®šä¹‰ï¼Œåˆ†åˆ«æ˜¯ï¼š`chan`ã€`chan <-`ã€`<- chan`ï¼Œå¯é€‰çš„`<-`ä»£è¡¨`channel`çš„æ–¹å‘ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šæ–¹å‘ï¼Œé‚£ä¹ˆ`channel`å°±æ˜¯åŒå‘çš„ï¼Œæ—¢å¯ä»¥æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥å‘é€æ•°æ®ã€‚

```go
chan T // æ¥æ”¶å’Œå‘é€ç±»å‹ä¸ºTçš„æ•°æ®
chan<- T // åªå¯ä»¥ç”¨æ¥å‘é€ T ç±»å‹çš„æ•°æ®
<- chan T // åªå¯ä»¥ç”¨æ¥æ¥æ”¶ T ç±»å‹çš„æ•°æ®
```

### åˆ›å»º`channel`

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`make`åˆå§‹åŒ–`channel`ï¼Œå¯ä»¥åˆ›å»ºä¸¤ç§ä¸¤ç§ç±»å‹çš„`channel`ï¼šæ— ç¼“å†²çš„`channel`å’Œæœ‰ç¼“å†²çš„`channel`ã€‚

ç¤ºä¾‹ï¼š

```go
ch_no_buffer := make(chan int)
ch_no_buffer := make(chan int, 0)
ch_buffer := make(chan int, 100)
```

æ²¡æœ‰è®¾ç½®å®¹é‡æˆ–è€…å®¹é‡è®¾ç½®ä¸º`0`ï¼Œåˆ™è¯´æ˜`channel`æ²¡æœ‰ç¼“å­˜ï¼Œæ­¤æ—¶åªæœ‰å‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½å‡†å¤‡å¥½åä»–ä»¬æ‰å¯ä»¥è¿›è¡Œé€šè®¯ï¼Œå¦åˆ™å°±æ˜¯ä¸€ç›´é˜»å¡ã€‚å¦‚æœå®¹é‡è®¾ç½®å¤§äº`0`ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå¸¦ç¼“å†²çš„`channel`ï¼Œå‘é€æ–¹åªæœ‰`buffer`æ»¡äº†ä¹‹åæ‰ä¼šé˜»å¡ï¼Œæ¥æ”¶æ–¹åªæœ‰ç¼“å­˜ç©ºäº†æ‰ä¼šé˜»å¡ã€‚

**æ³¨æ„ï¼šæœªåˆå§‹åŒ–ï¼ˆä¸ºnilï¼‰çš„`channel`æ˜¯ä¸å¯ä»¥é€šä¿¡çš„**

```go
func main()  {
	var ch chan string
	ch <- "asongçœŸå¸…"
	fmt.Println(<- ch)
}
// è¿è¡ŒæŠ¥é”™
fatal error: all goroutines are asleep - deadlock!
goroutine 1 [chan send (nil chan)]:
```


### `channel`å…¥é˜Ÿ

`channel`çš„å…¥é˜Ÿå®šä¹‰å¦‚ä¸‹ï¼š

```go
"channel" <- "è¦å…¥é˜Ÿçš„å€¼ï¼ˆå¯ä»¥æ˜¯è¡¨è¾¾å¼ï¼‰"
```

åœ¨æ— ç¼“å†²çš„`channel`ä¸­ï¼Œåªæœ‰åœ¨å‡ºé˜Ÿæ–¹å‡†å¤‡å¥½åï¼Œ`channel`æ‰ä¼šå…¥é˜Ÿï¼Œå¦åˆ™ä¸€ç›´é˜»å¡ç€ï¼Œæ‰€ä»¥è¯´æ— ç¼“å†²`channel`æ˜¯åŒæ­¥çš„ã€‚

åœ¨æœ‰ç¼“å†²çš„`channel`ä¸­ï¼Œç¼“å­˜æœªæ»¡æ—¶ï¼Œå°±ä¼šæ‰§è¡Œå…¥é˜Ÿæ“ä½œã€‚

**å‘`nil`çš„`channel`ä¸­å…¥é˜Ÿä¼šä¸€ç›´é˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚**

### `channel`å•ä¸ªå‡ºé˜Ÿ

`channel`çš„å•ä¸ªå‡ºé˜Ÿå®šä¹‰å¦‚ä¸‹ï¼š

```go
<- "channel"
```

æ— è®ºæ˜¯æœ‰æ— ç¼“å†²çš„`channel`åœ¨æ¥æ”¶ä¸åˆ°æ•°æ®æ—¶éƒ½ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å¯ä»¥æ¥æ”¶ã€‚

**ä»`nil`çš„`channel`ä¸­æ¥æ”¶æ•°æ®ä¼šä¸€ç›´é˜»å¡ã€‚**

`channel`çš„å‡ºé˜Ÿè¿˜æœ‰ä¸€ç§éé˜»å¡å†™æ³•ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
val, ok := <-ch
```

è¿™ä¹ˆå†™å¯ä»¥åˆ¤æ–­å½“å‰`channel`æ˜¯å¦å…³é—­ï¼Œå¦‚æœè¿™ä¸ª`channel`è¢«å…³é—­äº†ï¼Œ`ok`ä¼šè¢«è®¾ç½®ä¸º`false`ï¼Œ`val`å°±æ˜¯é›¶å€¼ã€‚



### `channel`å¾ªç¯å‡ºé˜Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`for-range`å¾ªç¯å¤„ç†`channel`ã€‚

```go
func main()  {
	ch := make(chan int,10)
	go func() {
		for i:=0;i<10;i++{
			ch <- i
		}
		close(ch)
	}()
	for val := range ch{
		fmt.Println(val)
	}
	fmt.Println("over")
}
```

`range ch`ä¼šä¸€ç›´è¿­ä»£åˆ°`channel`è¢«å…³é—­ã€‚åœ¨ä½¿ç”¨æœ‰ç¼“å†²`channel`æ—¶ï¼Œé…åˆ`for-range`æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚



### é…åˆ`select`ä½¿ç”¨

`Go`è¯­è¨€ä¸­çš„`select`èƒ½å¤Ÿè®©`Goroutine`åŒæ—¶ç­‰å¾…å¤šä¸ª`channel`è¯»æˆ–è€…å†™ï¼Œåœ¨`channel`çŠ¶æ€æœªæ”¹å˜ä¹‹å‰ï¼Œ`select`ä¼šä¸€ç›´é˜»å¡å½“å‰çº¿ç¨‹æˆ–`Goroutine`ã€‚å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š

```go
func fibonacci(ch chan int, done chan struct{}) {
	x, y := 0, 1
	for {
		select {
		case ch <- x:
			x, y = y, x+y
		case <-done:
			fmt.Println("over")
			return
		}
	}
}
func main() {
	ch := make(chan int)
	done := make(chan struct{})
	go func() {
		for i := 0; i < 10; i++ {
			fmt.Println(<-ch)
		}
		done <- struct{}{}
	}()
	fibonacci(ch, done)
}
```

`select`ä¸`switch`å…·æœ‰ç›¸ä¼¼çš„æ§åˆ¶ç»“æ„ï¼Œä¸`switch`ä¸åŒçš„æ˜¯ï¼Œ`select`ä¸­çš„`case`ä¸­çš„è¡¨è¾¾å¼å¿…é¡»æ˜¯`channel`çš„æ”¶å‘æ“ä½œï¼Œå½“`select`ä¸­çš„ä¸¤ä¸ª`case`åŒæ—¶è¢«è§¦å‘æ—¶ï¼Œä¼šéšæœºæ‰§è¡Œå…¶ä¸­çš„ä¸€ä¸ªã€‚ä¸ºä»€ä¹ˆæ˜¯éšæœºæ‰§è¡Œçš„å‘¢ï¼Ÿéšæœºçš„å¼•å…¥å°±æ˜¯ä¸ºäº†é¿å…é¥¥é¥¿é—®é¢˜çš„å‘ç”Ÿï¼Œå¦‚æœæˆ‘ä»¬æ¯æ¬¡éƒ½æ˜¯æŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œçš„ï¼Œè‹¥ä¸¤ä¸ª`case`ä¸€ç›´éƒ½æ˜¯æ»¡è¶³æ¡ä»¶çš„ï¼Œé‚£ä¹ˆåé¢çš„`case`æ°¸è¿œéƒ½ä¸ä¼šæ‰§è¡Œã€‚

ä¸Šé¢ä¾‹å­ä¸­çš„`select`ç”¨æ³•æ˜¯é˜»å¡å¼çš„æ”¶å‘æ“ä½œï¼Œç›´åˆ°æœ‰ä¸€ä¸ª`channel`å‘ç”ŸçŠ¶æ€æ”¹å˜ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨`select`ä¸­ä½¿ç”¨`default`è¯­å¥ï¼Œé‚£ä¹ˆ`select`è¯­å¥åœ¨æ‰§è¡Œæ—¶ä¼šé‡åˆ°è¿™ä¸¤ç§æƒ…å†µï¼š

- å½“å­˜åœ¨å¯ä»¥æ”¶å‘çš„` Channel `æ—¶ï¼Œç›´æ¥å¤„ç†è¯¥` Channel` å¯¹åº”çš„ `case`ï¼›
- å½“ä¸å­˜åœ¨å¯ä»¥æ”¶å‘çš„` Channel` æ—¶ï¼Œæ‰§è¡Œ `default` ä¸­çš„è¯­å¥ï¼›

**æ³¨æ„ï¼š`nil channel`ä¸Šçš„æ“ä½œä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¦‚æœæ²¡æœ‰`default case`,åªæœ‰`nil channel`çš„`select`ä¼šä¸€ç›´è¢«é˜»å¡ã€‚**

### å…³é—­`channel`

å†…å»ºçš„`close`æ–¹æ³•å¯ä»¥ç”¨æ¥å…³é—­`channel`ã€‚å¦‚æœ`channel`å·²ç»å…³é—­ï¼Œä¸å¯ä»¥ç»§ç»­å‘é€æ•°æ®äº†ï¼Œå¦åˆ™ä¼šå‘ç”Ÿ`panic`ï¼Œä½†æ˜¯ä»è¿™ä¸ªå…³é—­çš„`channel`ä¸­ä¸ä½†å¯ä»¥è¯»å–å‡ºå·²å‘é€çš„æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸æ–­çš„è¯»å–é›¶å€¼ã€‚

```go
func main()  {
	ch := make(chan int, 10)
	ch <- 10
	ch <- 20
	close(ch)
	fmt.Println(<-ch) //1
	fmt.Println(<-ch) //2
	fmt.Println(<-ch) //0
	fmt.Println(<-ch) //0
}
```



## `channel`åŸºæœ¬è®¾è®¡æ€æƒ³

`channel`è®¾è®¡çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š**ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡æ¥å®ç°å…±äº«å†…å­˜ï¼ˆDo not communicate by sharing memory; instead, share memory by communicatingï¼‰**ã€‚

è¿™ä¸ªæ€æƒ³å¤§å®¶æ˜¯å¦ç†è§£å‘¢ï¼Ÿæˆ‘åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸‹æˆ‘çš„ç†è§£(æŸ¥æ‰¾èµ„æ–™+ä¸ªäººç†è§£)ï¼Œæœ‰ä»€ä¹ˆä¸å¯¹çš„ï¼Œç•™è¨€åŒºæŒ‡æ­£æˆ–å¼€å–·ï¼

> ä»€ä¹ˆæ˜¯ä½¿ç”¨å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Ÿå…¶å®å°±æ˜¯å¤šä¸ªçº¿ç¨‹/åç¨‹ä½¿ç”¨åŒä¸€å—å†…å­˜ï¼Œé€šè¿‡åŠ é”çš„æ–¹å¼æ¥å®£å¸ƒä½¿ç”¨æŸå—å†…å­˜ï¼Œé€šè¿‡è§£é”æ¥å®£å¸ƒä¸å†ä½¿ç”¨æŸå—å†…å­˜ã€‚
>
> ä»€ä¹ˆæ˜¯é€šè¿‡é€šä¿¡æ¥å®ç°å…±äº«å†…å­˜ï¼Ÿå…¶å®å°±æ˜¯æŠŠä¸€ä»½å†…å­˜çš„å¼€é”€å˜æˆä¸¤ä»½å†…å­˜å¼€é”€è€Œå·²ï¼Œå†è¯´çš„é€šä¿—ä¸€ç‚¹å°±æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨å‘é€æ¶ˆæ¯çš„æ–¹å¼æ¥åŒæ­¥ä¿¡æ¯ã€‚
>
> ä¸ºä»€ä¹ˆé¼“åŠ±ä½¿ç”¨é€šè¿‡é€šä¿¡æ¥å®ç°å…±äº«å†…å­˜ï¼Ÿä½¿ç”¨å‘é€æ¶ˆæ¯æ¥åŒæ­¥ä¿¡æ¯ç›¸æ¯”äºç›´æ¥ä½¿ç”¨å…±äº«å†…å­˜å’Œäº’æ–¥é”æ˜¯ä¸€ç§æ›´é«˜çº§çš„æŠ½è±¡ï¼Œä½¿ç”¨æ›´é«˜çº§çš„æŠ½è±¡èƒ½å¤Ÿä¸ºæˆ‘ä»¬åœ¨ç¨‹åºè®¾è®¡ä¸Šæä¾›æ›´å¥½çš„å°è£…ï¼Œè®©ç¨‹åºçš„é€»è¾‘æ›´åŠ æ¸…æ™°ï¼›å…¶æ¬¡ï¼Œæ¶ˆæ¯å‘é€åœ¨è§£è€¦æ–¹é¢ä¸å…±äº«å†…å­˜ç›¸æ¯”ä¹Ÿæœ‰ä¸€å®šä¼˜åŠ¿ï¼Œæˆ‘ä»¬å¯ä»¥å°†çº¿ç¨‹çš„èŒè´£åˆ†æˆç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå¹¶é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼å°†å®ƒä»¬è§£è€¦ï¼Œä¸éœ€è¦å†ä¾èµ–å…±äº«å†…å­˜ã€‚
>
> å¯¹äºè¿™ä¸ªç†è§£æ›´æ·±çš„æ–‡ç« ï¼Œå»ºè®®è¯»ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼š[ä¸ºä»€ä¹ˆä½¿ç”¨é€šä¿¡æ¥å…±äº«å†…å­˜](https://draveness.me/whys-the-design-communication-shared-memory/)

`channel`åœ¨è®¾è®¡ä¸Šæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬å‘é€æ–¹é˜Ÿåˆ—ã€æ¥æ”¶æ–¹é˜Ÿåˆ—ã€äº’æ–¥é”ç­‰ç»“æ„ï¼Œä¸‹é¢æˆ‘å°±ä¸€èµ·ä»æºç å‡ºå‘ï¼Œå‰–æè¿™ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—æ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼



## æºç å‰–æ

### æ•°æ®ç»“æ„

åœ¨`src/runtime/chan.go`ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`hchan`çš„ç»“æ„å¦‚ä¸‹ï¼š

```go
type hchan struct {
	qcount   uint           // total data in the queue
	dataqsiz uint           // size of the circular queue
	buf      unsafe.Pointer // points to an array of dataqsiz elements
	elemsize uint16
	closed   uint32
	elemtype *_type // element type
	sendx    uint   // send index
	recvx    uint   // receive index
	recvq    waitq  // list of recv waiters
	sendq    waitq  // list of send waiters
	lock mutex
}
```

æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹`hchan`ä¸­æ¯ä¸ªå­—æ®µéƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼š

- `qcount`ï¼šå¾ªç¯æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡
- `dataqsiz`ï¼šå¾ªç¯æ•°ç»„çš„é•¿åº¦
- `buf`ï¼šåªé’ˆå¯¹æœ‰ç¼“å†²çš„`channel`ï¼ŒæŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„çš„æŒ‡é’ˆ
- `elemsize`ï¼šèƒ½å¤Ÿæ¥æ”¶å’Œå‘é€çš„å…ƒç´ å¤§å°
- `closed`ï¼š`channel`æ˜¯å¦å…³é—­æ ‡å¿—
- `elemtype`ï¼šè®°å½•`channel`ä¸­å…ƒç´ çš„ç±»å‹
- `sendx`ï¼šå·²å‘é€å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ç´¢å¼•
- `sendx`ï¼šå·²æ¥æ”¶å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ç´¢å¼•
- `recvq`ï¼šç­‰å¾…æ¥æ”¶çš„`goroutine`é˜Ÿåˆ—
- `senq`ï¼šç­‰å¾…å‘é€çš„`goroutine`é˜Ÿåˆ—
- `lock`ï¼šäº’æ–¥é”ï¼Œä¿æŠ¤`hchan`ä¸­çš„å­—æ®µï¼Œä¿è¯è¯»å†™`channel`çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚

è¿™ä¸ªç»“æ„ç»“åˆä¸Šé¢é‚£ä¸ªå›¾ç†è§£å°±æ›´æ¸…æ™°äº†ï¼š

- `buf`æ˜¯æŒ‡å‘åº•å±‚çš„å¾ªç¯æ•°ç»„ï¼Œ`dataqsiz`å°±æ˜¯è¿™ä¸ªå¾ªç¯æ•°ç»„çš„é•¿åº¦ï¼Œ`qcount`å°±æ˜¯å½“å‰å¾ªç¯æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡ï¼Œç¼“å†²çš„`channel`æ‰æœ‰æ•ˆã€‚
- `elemsize`å’Œ`elemtype`å°±æ˜¯æˆ‘ä»¬åˆ›å»º`channel`æ—¶è®¾ç½®çš„å®¹é‡å¤§å°å’Œå…ƒç´ ç±»å‹ã€‚
- `sendq`ã€`recvq`æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œåˆ†åˆ«è¡¨ç¤ºè¢«é˜»å¡çš„`goroutine`é“¾è¡¨ï¼Œè¿™äº› goroutine ç”±äºå°è¯•è¯»å– `channel` æˆ–å‘ `channel` å‘é€æ•°æ®è€Œè¢«é˜»å¡ã€‚

å¯¹äºä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥ç”»å‡ºæ¥è¿™æ ·çš„ä¸€ä¸ªç†è§£å›¾ï¼š

![](https://song-oss.oss-cn-beijing.aliyuncs.com/golang_dream/article/static/%E6%88%AA%E5%B1%8F2021-06-26%20%E4%B8%8B%E5%8D%884.45.09.png)

### `channel`çš„åˆ›å»º

å‰é¢ä»‹ç»`channel`å…¥é—¨çš„æ—¶å€™æˆ‘ä»¬å°±è¯´åˆ°äº†ï¼Œæˆ‘ä»¬ä½¿ç”¨`make`è¿›è¡Œåˆ›å»ºï¼Œ`make`åœ¨ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åå¯¹åº”çš„`runtime.makechan`æˆ–`runtime.makechan64`ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªåŒºåˆ«å‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹ä»£ç ï¼š

```go
// go 1.15.7
func makechan64(t *chantype, size int64) *hchan {
	if int64(int(size)) != size {
		panic(plainError("makechan: size out of range"))
	}

	return makechan(t, int(size))
}
```

`runtime.makechan64`æœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨çš„`makechan`æ–¹æ³•ï¼Œåªä¸è¿‡å¤šäº†ä¸€ä¸ªæ•°å€¼æº¢å‡ºçš„æ ¡éªŒã€‚`runtime.makechan64`æ˜¯ç”¨äºå¤„ç†ç¼“å†²åŒºå¤§äº2çš„32æ–¹ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°ç±»å‹å’Œç¼“å†²åŒºå¤§å°è¿›è¡Œé€‰æ‹©ã€‚å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯ä½¿ç”¨`makechan`ã€‚æˆ‘ä»¬åªéœ€è¦åˆ†æ`makechan`å‡½æ•°å°±å¯ä»¥äº†ã€‚

```go
func makechan(t *chantype, size int) *hchan {
	elem := t.elem
	// å¯¹å‘é€å…ƒç´ è¿›è¡Œé™åˆ¶ 1<<16 = 65536
	if elem.size >= 1<<16 {
		throw("makechan: invalid channel element type")
	}
  // æ£€æŸ¥æ˜¯å¦å¯¹é½
	if hchanSize%maxAlign != 0 || elem.align > maxAlign {
		throw("makechan: bad alignment")
	}
  // åˆ¤æ–­æ˜¯å¦ä¼šå‘ç”Ÿå†…å­˜æº¢å‡º
	mem, overflow := math.MulUintptr(elem.size, uintptr(size))
	if overflow || mem > maxAlloc-hchanSize || size < 0 {
		panic(plainError("makechan: size out of range"))
	}
  // æ„é€ hchanå¯¹è±¡
	var c *hchan
	switch {
  // è¯´æ˜æ˜¯æ— ç¼“å†²çš„channel
	case mem == 0:
		// Queue or element size is zero.
		c = (*hchan)(mallocgc(hchanSize, nil, true))
		// Race detector uses this location for synchronization.
		c.buf = c.raceaddr()
  // å…ƒç´ ç±»å‹ä¸åŒ…å«æŒ‡é’ˆï¼Œåªè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†é…
	// å¦‚æœhchanç»“æ„ä½“ä¸­ä¸å«æŒ‡é’ˆï¼Œgcå°±ä¸ä¼šæ‰«æchanä¸­çš„å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åˆ†é…
  // "hchan ç»“æ„ä½“å¤§å° + å…ƒç´ å¤§å°*ä¸ªæ•°" çš„å†…å­˜
	case elem.ptrdata == 0:
		// Allocate hchan and buf in one call.
		c = (*hchan)(mallocgc(hchanSize+mem, nil, true))
		c.buf = add(unsafe.Pointer(c), hchanSize)
  // å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œè¿›è¡Œä¸¤æ¬¡å†…å­˜åˆ†é…æ“ä½œ
	default:
		c = new(hchan)
		c.buf = mallocgc(mem, elem, true)
	}
	// åˆå§‹åŒ–hchanä¸­çš„å¯¹è±¡
	c.elemsize = uint16(elem.size)
	c.elemtype = elem
	c.dataqsiz = uint(size)
	lockInit(&c.lock, lockRankHchan)

	if debugChan {
		print("makechan: chan=", c, "; elemsize=", elem.size, "; dataqsiz=", size, "\n")
	}
	return c
}
```

æ³¨é‡Šæˆ‘éƒ½æ·»åŠ ä¸Šäº†ï¼Œåº”è¯¥å¾ˆå®¹æ˜“æ‡‚å§ï¼Œè¿™é‡Œåœ¨ç‰¹æ®Šè¯´ä¸€ä¸‹åˆ†é…å†…å­˜è¿™å—çš„å†…å®¹ï¼Œå…¶å®å½’ä¸€ä¸‹ç±»ï¼Œå°±åªæœ‰ä¸¤å—ï¼š

- åˆ†é…ä¸€æ¬¡å†…å­˜ï¼šè‹¥åˆ›å»ºçš„`channel`æ˜¯æ— ç¼“å†²çš„ï¼Œæˆ–è€…åˆ›å»ºçš„æœ‰ç¼“å†²çš„`channel`ä¸­å­˜å‚¨çš„ç±»å‹ä¸å­˜åœ¨æŒ‡é’ˆå¼•ç”¨ï¼Œå°±ä¼šè°ƒç”¨ä¸€æ¬¡`mallocgc`åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚
- åˆ†é…ä¸¤æ¬¡å†…å­˜ï¼šè‹¥åˆ›å»ºçš„æœ‰ç¼“å†²`channel`å­˜å‚¨çš„ç±»å‹å­˜åœ¨æŒ‡é’ˆå¼•ç”¨ï¼Œå°±ä¼šè¿åŒ`hchan`å’Œåº•å±‚æ•°ç»„åŒæ—¶åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚

å› ä¸ºéƒ½æ˜¯è°ƒç”¨`mallocgc`æ–¹æ³•è¿›è¡Œå†…å­˜åˆ†é…ï¼Œæ‰€ä»¥`channel`éƒ½æ˜¯åœ¨å †ä¸Šåˆ›å»ºçš„ï¼Œä¼šè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œä¸å…³é—­`close`æ–¹æ³•ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼ˆä½†æ˜¯æƒ³å†™å‡ºæ¼‚äº®çš„ä»£ç å°±ä¸å»ºè®®ä½ è¿™ä¹ˆåšäº†ï¼‰ã€‚



### `channel`å…¥é˜Ÿ

`channel`å‘é€æ•°æ®éƒ¨åˆ†çš„ä»£ç ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åå¯¹åº”çš„æ˜¯`runtime.chansend1`ï¼Œå…¶è°ƒç”¨çš„ä¹Ÿæ˜¯`runtime.chansend`æ–¹æ³•ï¼š

```go
func chansend1(c *hchan, elem unsafe.Pointer) {
	chansend(c, elem, true, getcallerpc())
}
```

æˆ‘ä»¬ä¸»è¦åˆ†æä¸€ä¸‹`chansend`æ–¹æ³•ï¼Œä»£ç æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬åˆ†å‡ ä¸ªæ­¥éª¤æ¥çœ‹è¿™æ®µä»£ç ï¼š

- å‰ç½®æ£€æŸ¥
- åŠ é”/å¼‚å¸¸æ£€æŸ¥
- `channel`ç›´æ¥å‘é€æ•°æ®
- `channel`å‘é€æ•°æ®ç¼“å†²åŒºæœ‰å¯ç”¨ç©ºé—´
- `channel`å‘é€æ•°æ®ç¼“å†²åŒºæ— å¯ç”¨ç©ºé—´

#### å‰ç½®æ£€æŸ¥

```go
	if c == nil {
		if !block {
			return false
		}
		gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2)
		throw("unreachable")
	}

	if debugChan {
		print("chansend: chan=", c, "\n")
	}

	if raceenabled {
		racereadpc(c.raceaddr(), callerpc, funcPC(chansend))
	}
	if !block && c.closed == 0 && full(c) {
		return false
	}

	var t0 int64
	if blockprofilerate > 0 {
		t0 = cputicks()
	}
```

è¿™é‡Œæœ€ä¸»è¦çš„æ£€æŸ¥å°±æ˜¯åˆ¤æ–­å½“å‰`channel`æ˜¯å¦ä¸º`nil`ï¼Œå¾€ä¸€ä¸ª`nil`çš„`channel`ä¸­å‘é€æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨`gopark`å‡½æ•°å°†å½“å‰æ‰§è¡Œçš„`goroutine`ä»`running`çŠ¶æ€è½¬å…¥`waiting`çŠ¶æ€ï¼Œè¿™è®©å°±ä¼šå¯¼è‡´è¿›ç¨‹å‡ºç°æ­»é”ï¼Œè¡¨è±¡å‡º`panic`äº‹ä»¶ã€‚

ç´§æ¥ç€ä¼šå¯¹éé˜»å¡çš„`channel`è¿›è¡Œä¸€ä¸ªä¸Šé™åˆ¤æ–­ï¼Œçœ‹çœ‹æ˜¯å¦å¿«é€Ÿå¤±è´¥ï¼Œè¿™é‡Œç›¸å¯¹äºä¹‹å‰çš„ç‰ˆæœ¬åšäº†æ”¹è¿›ï¼Œä½¿ç”¨`full`æ–¹æ³•æ¥å¯¹`hchan`ç»“æ„è¿›è¡Œæ ¡éªŒã€‚

```go
func full(c *hchan) bool {
	if c.dataqsiz == 0 {
		return c.recvq.first == nil
	}
	return c.qcount == c.dataqsiz
}
```

è¿™é‡Œå¿«é€Ÿå¤±è´¥æ ¡éªŒé€»è¾‘å¦‚ä¸‹ï¼š

- è‹¥æ˜¯ `qcount` ä¸ `dataqsiz` å¤§å°ç›¸åŒï¼ˆç¼“å†²åŒºå·²æ»¡ï¼‰æ—¶ï¼Œåˆ™ä¼šè¿”å›å¤±è´¥ã€‚
- éé˜»å¡ä¸”æœªå…³é—­ï¼ŒåŒæ—¶åº•å±‚æ•°æ® `dataqsiz` å¤§å°ä¸º` 0`ï¼ˆæ— ç¼“å†²`channel`ï¼‰ï¼Œå¦‚æœæ¥æ”¶æ–¹æ²¡å‡†å¤‡å¥½åˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚



#### åŠ é”/å¼‚å¸¸æ£€æŸ¥

```go
lock(&c.lock)

if c.closed != 0 {
		unlock(&c.lock)
		panic(plainError("send on closed channel"))
}
```

å‰ç½®æ ¡éªŒé€šè¿‡åï¼Œåœ¨å‘é€æ•°æ®çš„é€»è¾‘æ‰§è¡Œä¹‹å‰ä¼šå…ˆä¸ºå½“å‰çš„`channel`åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªåç¨‹å¹¶å‘ä¿®æ”¹æ•°æ®ã€‚å¦‚æœ` Channel` å·²ç»å…³é—­ï¼Œé‚£ä¹ˆå‘è¯¥ `Channel `å‘é€æ•°æ®æ—¶ä¼šæŠ¥` â€œsend on closed channelâ€ `é”™è¯¯å¹¶ä¸­æ­¢ç¨‹åºã€‚

#### `channel`ç›´æ¥å‘é€æ•°æ®

ç›´æ¥å‘é€æ•°æ®æ˜¯æŒ‡ å¦‚æœå·²ç»æœ‰é˜»å¡çš„æ¥æ”¶`goroutines`ï¼ˆå³`recvq`ä¸­æŒ‡å‘éç©ºï¼‰ï¼Œé‚£ä¹ˆæ•°æ®å°†è¢«ç›´æ¥å‘é€ç»™æ¥æ”¶`goroutine`ã€‚

```go
if sg := c.recvq.dequeue(); sg != nil {
		//æ‰¾åˆ°ä¸€ä¸ªç­‰å¾…çš„æ¥æ”¶å™¨ã€‚æˆ‘ä»¬å°†æƒ³è¦å‘é€çš„å€¼ç›´æ¥ä¼ é€’ç»™æ¥æ”¶è€…ï¼Œç»•è¿‡é€šé“ç¼“å†²åŒº(å¦‚æœæœ‰çš„è¯)ã€‚
		send(c, sg, ep, func() { unlock(&c.lock) }, 3)
		return true
}
```

è¿™é‡Œä¸»è¦æ˜¯è°ƒç”¨`Send`æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š

```go
func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) {
 // é™æ€ç«äº‰çœç•¥æ‰
  // elemæ˜¯æŒ‡æ¥æ”¶åˆ°çš„å€¼å­˜æ”¾çš„ä½ç½®
	if sg.elem != nil {
    // è°ƒç”¨sendDirectæ–¹æ³•ç›´æ¥è¿›è¡Œå†…å­˜æ‹·è´
    // ä»å‘é€è€…æ‹·è´åˆ°æ¥æ”¶è€…
		sendDirect(c.elemtype, sg, ep)
		sg.elem = nil
	}
  // ç»‘å®šgoroutine
	gp := sg.g
  // è§£é”
	unlockf()
	gp.param = unsafe.Pointer(sg)
	if sg.releasetime != 0 {
		sg.releasetime = cputicks()
	}
  // å”¤é†’æ¥æ”¶çš„ goroutine
	goready(gp, skip+1)
}
```

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹`SendDirect`æ–¹æ³•ï¼š

```go
func sendDirect(t *_type, sg *sudog, src unsafe.Pointer) {
	dst := sg.elem
	typeBitsBulkBarrier(t, uintptr(dst), uintptr(src), t.size)
	memmove(dst, src, t.size)
}
```

è¿™é‡Œè°ƒç”¨äº†`memove`æ–¹æ³•è¿›è¡Œå†…å­˜æ‹·è´ï¼Œè¿™é‡Œæ˜¯ä»ä¸€ä¸ª `goroutine` ç›´æ¥å†™å¦ä¸€ä¸ª `goroutine` æ ˆçš„æ“ä½œï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†ä¸€æ¬¡å†…å­˜ `copy`ï¼šä¸ç”¨å…ˆæ‹·è´åˆ° `channel` çš„` buf`ï¼Œç›´æ¥ç”±å‘é€è€…åˆ°æ¥æ”¶è€…ï¼Œæ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·ï¼Œæ•ˆç‡å¾—ä»¥æé«˜ï¼Œå®Œç¾ã€‚



#### `channel`å‘é€æ•°æ®ç¼“å†²åŒºæœ‰å¯ç”¨ç©ºé—´

æ¥ç€å¾€ä¸‹çœ‹ä»£ç ï¼Œåˆ¤æ–­`channel`ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰å¯ç”¨ç©ºé—´ï¼š

```go
// åˆ¤æ–­é€šé“ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰å¯ç”¨ç©ºé—´
if c.qcount < c.dataqsiz {
		qp := chanbuf(c, c.sendx)
		if raceenabled {
			raceacquire(qp)
			racerelease(qp)
		}
		typedmemmove(c.elemtype, qp, ep)
  	// æŒ‡å‘ä¸‹ä¸€ä¸ªå¾…å‘é€å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ä½ç½®
		c.sendx++
   // å› ä¸ºå­˜å‚¨æ•°æ®å…ƒç´ çš„ç»“æ„æ˜¯å¾ªç¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥å½“å½“å‰ç´¢å¼•å·å·²ç»åˆ°é˜Ÿæœ«æ—¶ï¼Œå°†ç´¢å¼•å·è°ƒæ•´åˆ°é˜Ÿå¤´
		if c.sendx == c.dataqsiz {
			c.sendx = 0
		}
  	// å½“å‰å¾ªç¯é˜Ÿåˆ—ä¸­å­˜å‚¨å…ƒç´ æ•°+1
		c.qcount++
   // é‡Šæ”¾é”ï¼Œå‘é€æ•°æ®å®Œæ¯•
		unlock(&c.lock)
		return true
}
```

è¿™é‡Œçš„å‡ ä¸ªæ­¥éª¤è¿˜æ˜¯æŒºå¥½ç†è§£çš„ï¼Œæ³¨é‡Šå·²ç»æ·»åŠ åˆ°ä»£ç ä¸­äº†ï¼Œæˆ‘ä»¬å†æ¥è¯¦ç»†è§£æä¸€ä¸‹ï¼š

- å¦‚æœå½“å‰ç¼“å†²åŒºè¿˜æœ‰å¯ç”¨ç©ºé—´ï¼Œåˆ™è°ƒç”¨`chanbuf`æ–¹æ³•è·å–åº•å±‚ç¼“å†²æ•°ç»„ä¸­`sendx`ç´¢å¼•çš„å…ƒç´ æŒ‡é’ˆå€¼
- è°ƒç”¨`typedmemmove`æ–¹æ³•å°†å‘é€çš„å€¼æ‹·è´åˆ°ç¼“å†²åŒºä¸­
- æ•°æ®æ‹·è´æˆåŠŸï¼Œ`sendx`è¿›è¡Œ+1æ“ä½œï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¾…å‘é€å…ƒç´ åœ¨å¾ªç¯æ•°ç»„ä¸­çš„ä½ç½®ã€‚å¦‚æœä¸‹ä¸€ä¸ªç´¢å¼•ä½ç½®æ­£å¥½æ˜¯å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠæ‰€è°“ä½ç½®å½’0ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ªç¯ç¯å½¢é˜Ÿåˆ—ã€‚
- å‘é€æ•°æ®æˆåŠŸåï¼Œé˜Ÿåˆ—å…ƒç´ é•¿åº¦è‡ªå¢ï¼Œè‡³æ­¤å‘é€æ•°æ®å®Œæ¯•ï¼Œé‡Šæ”¾é”ï¼Œè¿”å›ç»“æœå³å¯ã€‚



#### `channel`å‘é€æ•°æ®ç¼“å†²åŒºæ— å¯ç”¨ç©ºé—´

ç¼“å†²åŒºç©ºé—´ä¹Ÿä¼šæœ‰æ»¡äº†çš„æ—¶å€™ï¼Œè¿™æ˜¯æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€‰æ‹©ï¼Œä¸€ç§æ˜¯ç›´æ¥è¿”å›ï¼Œå¦å¤–ä¸€ç§æ˜¯é˜»å¡ç­‰å¾…ã€‚

ç›´æ¥è¿”å›çš„ä»£ç å°±å¾ˆç®€å•äº†ï¼Œåšä¸€ä¸ªç®€å•çš„æ˜¯å¦é˜»å¡åˆ¤æ–­ï¼Œä¸é˜»å¡çš„è¯ï¼Œç›´æ¥é‡Šæ”¾é”ï¼Œè¿”å›å³å¯ã€‚

```go
if !block {
		unlock(&c.lock)
		return false
}
```

é˜»å¡çš„è¯ä»£ç ç¨å¾®é•¿ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š

```go
  gp := getg()
	mysg := acquireSudog()
	mysg.releasetime = 0
	if t0 != 0 {
		mysg.releasetime = -1
	}
	mysg.elem = ep
	mysg.waitlink = nil
	mysg.g = gp
	mysg.isSelect = false
	mysg.c = c
	gp.waiting = mysg
	gp.param = nil
	c.sendq.enqueue(mysg)
	atomic.Store8(&gp.parkingOnChan, 1)
	gopark(chanparkcommit, unsafe.Pointer(&c.lock), waitReasonChanSend, traceEvGoBlockSend, 2)
  KeepAlive(ep)
```

é¦–å…ˆé€šè¿‡è°ƒç”¨`gettg`è·å–å½“å‰æ‰§è¡Œçš„`goroutine`ï¼Œç„¶åè°ƒç”¨`acquireSudog`æ–¹æ³•æ„é€ `sudog`ç»“æ„ä½“ï¼Œç„¶åè®¾ç½®å¾…å‘é€ä¿¡æ¯å’Œ`goroutine`ç­‰ä¿¡æ¯ï¼ˆ`sudog` é€šè¿‡ `g` å­—æ®µç»‘å®š `goroutine`ï¼Œè€Œ` goroutine` é€šè¿‡` waiting `ç»‘å®š `sudog`ï¼Œ`sudog` è¿˜é€šè¿‡ `elem` å­—æ®µç»‘å®šå¾…å‘é€å…ƒç´ çš„åœ°å€ï¼‰ï¼›æ„é€ å®Œæ¯•åè°ƒç”¨`c.sendq.enqueue`å°†å…¶æ”¾å…¥å¾…å‘é€çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨`gopark`æ–¹æ³•æŒ‚èµ·å½“å‰çš„`goroutine`è¿›å…¥`wait`çŠ¶æ€ã€‚

è¿™é‡Œåœ¨æœ€åè°ƒç”¨äº†`KeepAlive`æ–¹æ³•ï¼Œå¾ˆå¤šäººå¯¹è¿™ä¸ªæ¯”è¾ƒæ‡µé€¼ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯ä¸ºäº†ä¿è¯å¾…å‘é€çš„æ•°æ®å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯åˆ†é…åœ¨å †ä¸Šé¿å…è¢«GCã€‚è¿™é‡Œæˆ‘åœ¨ç”»ä¸€ä¸ªå›¾è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ç»‘å®šè¿‡ç¨‹ï¼Œæ›´åŠ æ·±ç†è§£ã€‚

![](https://song-oss.oss-cn-beijing.aliyuncs.com/golang_dream/article/static/%E6%88%AA%E5%B1%8F2021-06-26%20%E4%B8%8B%E5%8D%885.20.19.png)

ç°åœ¨`goroutine`å¤„äº`wait`çŠ¶æ€äº†ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œå”¤é†’ä»£ç å¦‚ä¸‹ï¼š

```go
 if mysg != gp.waiting {
		throw("G waiting list is corrupted")
	}
	gp.waiting = nil
	gp.activeStackChans = false
	if gp.param == nil {
		if c.closed == 0 {
			throw("chansend: spurious wakeup")
		}
    // å”¤é†’åchannelè¢«å…³é—­äº†ï¼Œç›´æ¥panic
		panic(plainError("send on closed channel"))
	}
	gp.param = nil
	if mysg.releasetime > 0 {
		blockevent(mysg.releasetime-t0, 2)
	}
 // å»æ‰mysgä¸Šç»‘å®šçš„channel
	mysg.c = nil
  // é‡Šæ”¾sudog
	releaseSudog(mysg)
	return true
```

å”¤é†’çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆåˆ¤æ–­`goroutine`æ˜¯å¦è¿˜å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å”¤é†’åè¿˜æœ‰ä¸€ä¸ªæ£€æŸ¥æ˜¯åˆ¤æ–­å½“å‰`channel`æ˜¯å¦è¢«å…³é—­äº†ï¼Œå…³é—­äº†åˆ™è§¦å‘`panic`ã€‚æœ€åæˆ‘ä»¬å¼€å§‹å–æ¶ˆ`mysg`ä¸Šçš„`channel`ç»‘å®šå’Œ`sudog`çš„é‡Šæ”¾ã€‚

è¿™é‡Œå¤§å®¶è‚¯å®šå¥½å¥‡ï¼Œæ€ä¹ˆæ²¡æœ‰çœ‹åˆ°å”¤é†’åæ‰§è¡Œå‘é€æ•°æ®åŠ¨ä½œï¼Ÿä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯æˆ‘ä»¬ç†è§£é”™äº†ã€‚åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»ä½¿`goroutine`è¿›å…¥äº†`wait`çŠ¶æ€ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨åœ¨åœæ­¢`g` æ—¶ä¼šè®°å½•è¿è¡Œçº¿ç¨‹å’Œæ–¹æ³•å†…æ‰§è¡Œçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª`ch <- "asong"`ä½ç½®ï¼Œå”¤é†’åä¼šåœ¨è¿™ä¸ªä½ç½®å¼€å§‹æ‰§è¡Œï¼Œä»£ç åˆå¼€å§‹é‡æ–°æ‰§è¡Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹å‰è¿›å…¥`wait`çŠ¶æ€çš„ç»‘å®šæ˜¯è¦è§£ç»‘ä¸é‡Šæ”¾çš„ï¼Œå¦åˆ™ä¸‹æ¬¡è¿›æ¥å°±ä¼šå‡ºç°é—®é¢˜å–½ã€‚



### æ¥æ”¶æ•°æ®

ä¹‹å‰æˆ‘ä»¬ä»‹ç»è¿‡`channel`æ¥æ”¶æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š

```go
val := <- ch
val, ok := <- ch
```

å®ƒä»¬åœ¨ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘ååˆ†åˆ«å¯¹åº”çš„æ˜¯`runtime.chanrecv1` å’Œ `runtime.chanrecv2`ï¼š

```go
//go:nosplit
func chanrecv1(c *hchan, elem unsafe.Pointer) {
	chanrecv(c, elem, true)
}

//go:nosplit
func chanrecv2(c *hchan, elem unsafe.Pointer) (received bool) {
	_, received = chanrecv(c, elem, true)
	return
}
```

å…¶å®éƒ½æ˜¯è°ƒç”¨`chanrecv`æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è§£æè¿™ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ã€‚æ¥æ”¶éƒ¨åˆ†çš„ä»£ç å’Œæ¥æ”¶éƒ¨åˆ†çš„ä»£ç æ˜¯ç›¸å¯¹åº”çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ†å‡ ä¸ªæ­¥éª¤æ¥çœ‹è¿™éƒ¨åˆ†ä»£ç ï¼š

- å‰ç½®æ£€æŸ¥
- åŠ é”å’Œæå‰è¿”å›
- `channel`ç›´æ¥æ¥æ”¶æ•°æ®
- `channel`ç¼“å†²åŒºæœ‰æ•°æ®
- `channel`ç¼“å†²åŒºæ— æ•°æ®



#### å‰ç½®æ£€æŸ¥

```go
if c == nil {
		if !block {
			return
}
		gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2)
		throw("unreachable")
}
if atomic.Load(&c.closed) == 0 {
			return
}
if empty(c) {
		if raceenabled {
				raceacquire(c.raceaddr())
		}
		if ep != nil {
				typedmemclr(c.elemtype, ep)
		}
			return true, false
  }
}

var t0 int64
if blockprofilerate > 0 {
	t0 = cputicks()
}
```

é¦–å…ˆä¹Ÿä¼šåˆ¤æ–­å½“å‰`channel`æ˜¯å¦ä¸º`nil channel`ï¼Œå¦‚æœæ˜¯`nil channel`ä¸”ä¸ºéé˜»å¡æ¥æ”¶ï¼Œåˆ™ç›´æ¥è¿”å›å³å¯ã€‚å¦‚æœæ˜¯`nil channel`ä¸”ä¸ºé˜»å¡æ¥æ”¶ï¼Œåˆ™ç›´æ¥è°ƒç”¨`gopark`æ–¹æ³•æŒ‚èµ·å½“å‰`goroutine`ã€‚

ç„¶åä¹Ÿä¼šè¿›è¡Œå¿«é€Ÿå¤±è´¥æ£€æŸ¥ï¼Œè¿™é‡Œåªä¼šå¯¹éé˜»å¡æ¥æ”¶çš„`channel`è¿›è¡Œå¿«é€Ÿå¤±è´¥æ£€æŸ¥ï¼Œæ£€æŸ¥è§„åˆ™å¦‚ä¸‹ï¼š

```go
func empty(c *hchan) bool {
	// c.dataqsiz is immutable.
	if c.dataqsiz == 0 {
		return atomic.Loadp(unsafe.Pointer(&c.sendq.first)) == nil
	}
	return atomic.Loaduint(&c.qcount) == 0
}
```

å½“å¾ªç¯é˜Ÿåˆ—ä¸º `0`ä¸”ç­‰å¾…é˜Ÿåˆ— `sendq `å†…æ²¡æœ‰ `goroutine` æ­£åœ¨ç­‰å¾…æˆ–è€…ç¼“å†²åŒºæ•°ç»„ä¸ºç©ºæ—¶ï¼Œå¦‚æœ`channel`è¿˜æœªå…³é—­ï¼Œè¿™è¯´æ˜æ²¡æœ‰è¦æ¥æ”¶çš„æ•°æ®ï¼Œç›´æ¥è¿”å›å³å¯ã€‚å¦‚æœ`channel`å·²ç»å…³é—­äº†ä¸”ç¼“å­˜åŒºæ²¡æœ‰æ•°æ®äº†ï¼Œåˆ™ä¼šæ¸…ç†`ep`æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶è¿”å›ã€‚è¿™é‡Œä¸ºä»€ä¹ˆæ¸…ç†`ep`æŒ‡é’ˆå‘¢ï¼Ÿ`ep`æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ª`ep`å°±æ˜¯æˆ‘ä»¬è¦æ¥æ”¶çš„å€¼å­˜æ”¾çš„åœ°å€ï¼ˆ`val := <-ch val`å°±æ˜¯`ep`  ï¼‰ï¼Œå³ä½¿`channel`å…³é—­äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¥æ”¶é›¶å€¼ã€‚

#### åŠ é”å’Œæå‰è¿”å›

```go
	lock(&c.lock)

	if c.closed != 0 && c.qcount == 0 {
		if raceenabled {
			raceacquire(c.raceaddr())
		}
		unlock(&c.lock)
		if ep != nil {
			typedmemclr(c.elemtype, ep)
		}
		return true, false
	}
```

å‰ç½®æ ¡éªŒé€šè¿‡åï¼Œåœ¨æ‰§è¡Œæ¥æ”¶æ•°æ®çš„é€»è¾‘ä¹‹å‰ä¼šå…ˆä¸ºå½“å‰çš„`channel`åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªåç¨‹å¹¶å‘æ¥æ”¶æ•°æ®ã€‚åŒæ ·ä¹Ÿä¼šåˆ¤æ–­å½“å‰`channel`æ˜¯å¦è¢«å…³é—­ï¼Œå¦‚æœ`channel`è¢«å…³é—­äº†ï¼Œå¹¶ä¸”ç¼“å­˜åŒºæ²¡æœ‰æ•°æ®äº†ï¼Œåˆ™ç›´æ¥é‡Šæ”¾é”å’Œæ¸…ç†`ep`ä¸­çš„æŒ‡é’ˆæ•°æ®ï¼Œä¸éœ€è¦å†èµ°æ¥ä¸‹æ¥çš„æµç¨‹ã€‚



#### `channel`ç›´æ¥æ¥æ”¶æ•°æ®

è¿™ä¸€æ­¥ä¸`channel`ç›´æ¥å‘é€æ•°æ®æ˜¯å¯¹åº”çš„ï¼Œå½“å‘ç°`channel`ä¸Šæœ‰æ­£åœ¨é˜»å¡ç­‰å¾…çš„å‘é€æ–¹æ—¶ï¼Œåˆ™ç›´æ¥è¿›è¡Œæ¥æ”¶ã€‚

```go
if sg := c.sendq.dequeue(); sg != nil {
		recv(c, sg, ep, func() { unlock(&c.lock) }, 3)
		return true, true
	}
```

ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œæœ‰`goroutine`å­˜åœ¨ï¼Œæœ‰ä¸¤ç§å¯èƒ½ï¼š

- éç¼“å†²çš„`channel`
- ç¼“å†²çš„`channel`ï¼Œä½†æ˜¯ç¼“å†²åŒºæ»¡äº†

é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µï¼Œåœ¨`recv`æ–¹æ³•ä¸­çš„æ‰§è¡Œé€»è¾‘æ˜¯ä¸åŒçš„ï¼š

```go
func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) {
  // éç¼“å†²channel
	if c.dataqsiz == 0 {
    // æœªå¿½ç•¥æ¥æ”¶å€¼
		if ep != nil {
			// ç›´æ¥ä»å‘é€æ–¹æ‹·è´æ•°æ®åˆ°æ¥æ”¶æ–¹
			recvDirect(c.elemtype, sg, ep)
		}
	} else { // æœ‰ç¼“å†²channelï¼Œä½†æ˜¯ç¼“å†²åŒºæ»¡äº†
    // ç¼“å†²åŒºæ»¡æ—¶ï¼Œæ¥æ”¶æ–¹å’Œå‘é€æ–¹æ¸¸æ ‡é‡åˆäº†
    // å› ä¸ºæ˜¯å¾ªç¯é˜Ÿåˆ—ï¼Œéƒ½æ˜¯æ¸¸æ ‡0çš„ä½ç½®
    // è·å–å½“å‰æ¥æ”¶æ–¹æ¸¸æ ‡ä½ç½®ä¸‹çš„å€¼
		qp := chanbuf(c, c.recvx)
		// æœªå¿½ç•¥å€¼çš„æƒ…å†µä¸‹ç›´æ¥ä»å‘é€æ–¹æ‹·è´æ•°æ®åˆ°æ¥æ”¶æ–¹
		if ep != nil {
			typedmemmove(c.elemtype, ep, qp)
		}
		// å°†å‘é€è€…æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­
		typedmemmove(c.elemtype, qp, sg.elem)
    // è‡ªå¢åˆ°ä¸‹ä¸€ä¸ªå¾…æ¥æ”¶ä½ç½®
		c.recvx++
    // å¦‚æœä¸‹ä¸€ä¸ªå¾…æ¥æ”¶ä½ç½®ç­‰äºé˜Ÿåˆ—é•¿åº¦äº†ï¼Œåˆ™ä¸‹ä¸€ä¸ªå¾…æ¥æ”¶ä½ç½®ä¸ºé˜Ÿå¤´ï¼Œå› ä¸ºæ˜¯å¾ªç¯é˜Ÿåˆ—
		if c.recvx == c.dataqsiz {
			c.recvx = 0
		}
    // ä¸Šé¢å·²ç»å°†å‘é€è€…æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­äº†ï¼Œæ‰€ä»¥ç¼“å†²åŒºè¿˜æ˜¯æ»¡çš„ï¼Œæ‰€ä»¥å‘é€æ–¹ä½ç½®ä»ç„¶ç­‰äºæ¥æ”¶æ–¹ä½ç½®ã€‚
		c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz
	}
	sg.elem = nil
  // ç»‘å®šå‘é€æ–¹goroutine
	gp := sg.g
	unlockf()
	gp.param = unsafe.Pointer(sg)
	if sg.releasetime != 0 {
		sg.releasetime = cputicks()
	}
  // å”¤é†’å‘é€æ–¹çš„goroutine
	goready(gp, skip+1)
}
```

ä»£ç ä¸­çš„æ³¨é‡Šå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œä½†è¿˜æ˜¯æƒ³åœ¨è§£é‡Šä¸€éï¼Œè¿™é‡Œä¸»è¦å°±æ˜¯åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š

- éç¼“å†²åŒº`channel`ï¼šæœªå¿½ç•¥æ¥æ”¶å€¼æ—¶ç›´æ¥è°ƒç”¨`recvDirect`æ–¹æ³•ç›´æ¥ä»å‘é€æ–¹çš„`goroutine`è°ƒç”¨æ ˆä¸­å°†æ•°æ®æ‹·è´åˆ°æ¥æ”¶æ–¹çš„`goroutine`ã€‚
- å¸¦ç¼“å†²åŒºçš„`channel`ï¼šé¦–å…ˆè°ƒç”¨`chanbuf`æ–¹æ³•æ ¹æ®`recv`ç´¢å¼•çš„ä½ç½®è¯»å–ç¼“å†²åŒºå…ƒç´ ï¼Œå¹¶å°†å…¶æ‹·è´åˆ°æ¥æ”¶æ–¹çš„å†…å­˜åœ°å€ï¼›æ‹·è´å®Œæ¯•åè°ƒæ•´`sendx`å’Œ`recvx`ç´¢å¼•ä½ç½®ã€‚

æœ€ååˆ«å¿˜äº†è¿˜æœ‰ä¸€ä¸ªæ“ä½œå°±æ˜¯è°ƒç”¨`goready`æ–¹æ³•å”¤é†’å‘é€æ–¹çš„`goroutine`å¯ä»¥ç»§ç»­å‘é€æ•°æ®äº†ã€‚



#### `channel`ç¼“å†²åŒºæœ‰æ•°æ®

æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ä»£ç ï¼Œè‹¥å½“å‰`channel`çš„ç¼“å†²åŒºæœ‰æ•°æ®æ—¶ï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š

```go
  // ç¼“å†²channelï¼Œbufé‡Œæœ‰å¯ç”¨å…ƒç´ ï¼Œå‘é€æ–¹ä¹Ÿå¯ä»¥æ­£å¸¸å‘é€
   if c.qcount > 0 {
     // ç›´æ¥ä»å¾ªç¯é˜Ÿåˆ—ä¸­æ‰¾åˆ°è¦æ¥æ”¶çš„å…ƒç´ 
		qp := chanbuf(c, c.recvx)
    // æœªå¿½ç•¥æ¥æ”¶å€¼ï¼Œç›´æ¥æŠŠç¼“å†²åŒºçš„å€¼æ‹·è´åˆ°æ¥æ”¶æ–¹ä¸­
		if ep != nil {
			typedmemmove(c.elemtype, ep, qp)
		}
     // æ¸…ç†æ‰å¾ªç¯æ•°ç»„é‡Œç›¸åº”ä½ç½®çš„å€¼
		typedmemclr(c.elemtype, qp)
     // æ¥æ”¶æ¸¸æ ‡å‘å‰ç§»åŠ¨
		c.recvx++
     // è¶…è¿‡å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦æ—¶ï¼Œæ¥æ”¶æ¸¸æ ‡å½’0ï¼ˆå¾ªç¯é˜Ÿåˆ—ï¼‰
		if c.recvx == c.dataqsiz {
			c.recvx = 0
		}
     // å¾ªç¯é˜Ÿåˆ—ä¸­çš„æ•°æ®æ•°é‡å‡1
		c.qcount--
    // æ¥æ”¶æ•°æ®å®Œæ¯•ï¼Œé‡Šæ”¾é”
		unlock(&c.lock)
		return true, true
	}

	if !block {
		unlock(&c.lock)
		return false, false
	}
```

è¿™æ®µä»£ç æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œå°±ä¸å†è§£é‡Šä¸€éäº†ã€‚



#### `channel`ç¼“å†²åŒºæ— æ•°æ®

ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œç°åœ¨å¯ä»¥ç¡®å®šç›®å‰è¿™ä¸ª`channel`æ—¢æ²¡æœ‰å¾…å‘é€çš„`goroutine`ï¼Œå¹¶ä¸”ç¼“å†²åŒºä¹Ÿæ²¡æœ‰æ•°æ®ã€‚æ¥ä¸‹æ¥å°±çœ‹æˆ‘ä»¬æ˜¯å¦é˜»å¡ç­‰å¾…æ¥æ”¶æ•°æ®äº†ï¼Œä¹Ÿå°±æœ‰äº†å¦‚ä¸‹åˆ¤æ–­ï¼š

```go
	if !block {
		unlock(&c.lock)
		return false, false
	}
```

éé˜»å¡æ¥æ”¶æ•°æ®çš„è¯ï¼Œç›´æ¥è¿”å›å³å¯ï¼›å¦åˆ™åˆ™è¿›å…¥é˜»å¡æ¥æ”¶æ¨¡å¼ï¼š

```go
  gp := getg()
	mysg := acquireSudog()
	mysg.releasetime = 0
	if t0 != 0 {
		mysg.releasetime = -1
	}
	mysg.elem = ep
	mysg.waitlink = nil
	gp.waiting = mysg
	mysg.g = gp
	mysg.isSelect = false
	mysg.c = c
	gp.param = nil
	c.recvq.enqueue(mysg)
	atomic.Store8(&gp.parkingOnChan, 1)
	gopark(chanparkcommit,  unsafe.Pointer(&c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2)
```

è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘åŸºæœ¬ä¸å‘é€é˜»å¡éƒ¨åˆ†ä¸€æ¨¡ä¸€æ ·ï¼Œå¤§æ¦‚é€»è¾‘å°±æ˜¯è·å–å½“å‰çš„`goroutine`ï¼Œç„¶åæ„å»º`sudog`ç»“æ„ä¿å­˜å¾…æ¥æ”¶æ•°æ®çš„åœ°å€ä¿¡æ¯å’Œ`goroutine`ä¿¡æ¯ï¼Œå¹¶å°†`sudog`åŠ å…¥ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ï¼Œæœ€åæŒ‚èµ·å½“å‰`goroutine`ï¼Œç­‰å¾…å”¤é†’ã€‚

æ¥ä¸‹æ¥çš„ç¯å¢ƒé€»è¾‘ä¹Ÿæ²¡æœ‰ç‰¹åˆ«è¦è¯´çš„ï¼Œä¸å‘é€æ–¹å”¤é†’éƒ¨åˆ†ä¸€æ¨¡ä¸€æ ·ï¼Œä¸æ‡‚çš„å¯ä»¥çœ‹å‰é¢ã€‚å”¤é†’åçš„ä¸»è¦å·¥ä½œå°±æ˜¯æ¢å¤ç°åœºï¼Œé‡Šæ”¾ç»‘å®šä¿¡æ¯ã€‚



## å…³é—­`channel`

ä½¿ç”¨`close`å¯ä»¥å…³é—­`channel`ï¼Œå…¶ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åå¯¹åº”çš„æ˜¯`runtime.closechan`æ–¹æ³•ï¼Œè¯¦ç»†é€»è¾‘æˆ‘ä»¬é€šè¿‡æ³¨é‡Šåˆ°ä»£ç ä¸­ï¼š

```go
func closechan(c *hchan) {
  // å¯¹ä¸€ä¸ªnilçš„channelè¿›è¡Œå…³é—­ä¼šå¼•å‘panic
	if c == nil {
		panic(plainError("close of nil channel"))
	}
  // åŠ é”
	lock(&c.lock)
  // å…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„channelä¹Ÿä¼šå¼•å‘channel
	if c.closed != 0 {
		unlock(&c.lock)
		panic(plainError("close of closed channel"))
	}
	// å…³é—­channnelæ ‡å¿—
	c.closed = 1
 // Goroutineé›†åˆ
	var glist gList

	// æ¥å—è€…çš„ sudog ç­‰å¾…é˜Ÿåˆ—ï¼ˆrecvqï¼‰åŠ å…¥åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­
	for {
		sg := c.recvq.dequeue()
		if sg == nil {
			break
		}
		if sg.elem != nil {
			typedmemclr(c.elemtype, sg.elem)
			sg.elem = nil
		}
		if sg.releasetime != 0 {
			sg.releasetime = cputicks()
		}
		gp := sg.g
		gp.param = nil
		if raceenabled {
			raceacquireg(gp, c.raceaddr())
		}
		glist.push(gp)
	}

	// å‘é€æ–¹çš„sudogä¹ŸåŠ å…¥åˆ°åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­
	for {
		sg := c.sendq.dequeue()
		if sg == nil {
			break
		}
    // è¦å…³é—­çš„goroutineï¼Œå‘é€çš„å€¼è®¾ä¸ºnil
		sg.elem = nil
		if sg.releasetime != 0 {
			sg.releasetime = cputicks()
		}
		gp := sg.g
		gp.param = nil
		if raceenabled {
			raceacquireg(gp, c.raceaddr())
		}
		glist.push(gp)
	}
  // é‡Šæ”¾äº†å‘é€æ–¹å’Œæ¥æ”¶æ–¹åï¼Œé‡Šæ”¾é”å°±å¯ä»¥äº†ã€‚
	unlock(&c.lock)

	// å°†æ‰€æœ‰ glist ä¸­çš„ goroutine çŠ¶æ€ä» _Gwaiting è®¾ç½®ä¸º _Grunnable çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚
  // æˆ‘ä»¬æ—¢ç„¶æ˜¯ä»sendqå’Œrecvqä¸­è·å–çš„goroutineï¼ŒçŠ¶æ€éƒ½æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦å”¤é†’ä»–ä»¬ï¼Œèµ°åé¢çš„æµç¨‹ã€‚
	for !glist.empty() {
		gp := glist.pop()
		gp.schedlink = 0
		goready(gp, 3)
	}
}
```

è¿™é‡Œé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œå½’çº³æ€»ç»“ä¸€ä¸‹ï¼š

- ä¸€ä¸ªä¸º`nil`çš„`channel`ä¸å…è®¸è¿›è¡Œå…³é—­
- ä¸å¯ä»¥é‡å¤å…³é—­`channel`
- è·å–å½“å‰æ­£åœ¨é˜»å¡çš„å‘é€æˆ–è€…æ¥æ”¶çš„`goroutine`ï¼Œä»–ä»¬éƒ½å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç„¶åè¿›è¡Œå”¤é†’ã€‚è¿™æ˜¯å‘é€æ–¹ä¸å…è®¸åœ¨å‘`channel`å‘é€æ•°æ®äº†ï¼Œä½†æ˜¯ä¸å½±å“æ¥æ”¶æ–¹ç»§ç»­æ¥æ”¶å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œè·å–åˆ°çš„å…ƒç´ æ˜¯é›¶å€¼ã€‚ä½¿ç”¨`val,ok := <-ch`å¯ä»¥åˆ¤æ–­å½“å‰`channel`æ˜¯å¦è¢«å…³é—­ã€‚



## æ€»ç»“

å“‡å¡ï¼Œå¼€å¾€å¹¼å„¿å›­çš„è½¦ç»ˆäºåœäº†ï¼Œå°æ¾å­å” å” å¨å¨ä¸€è·¯äº†ï¼Œä½ ä»¬å­¦ä¼šäº†å—ï¼Ÿ

æˆ‘ä»¬ä»å…¥é—¨å¼€å§‹åˆ°æœ€åçš„æºç å‰–æï¼Œå…¶å®`channel`çš„è®¾è®¡ä¸€ç‚¹ä¹Ÿä¸å¤æ‚ï¼Œæºç ä¹Ÿæ˜¯å¾ˆå®¹æ˜“çœ‹æ‡‚çš„ï¼Œæœ¬è´¨å°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—å˜›ï¼Œå‘é€æ•°æ®éµå¾ªFIFOï¼ˆFirst In First Outï¼‰åŸè¯­ï¼Œæ•°æ®ä¼ é€’ä¾èµ–äºå†…å­˜æ‹·è´ã€‚ä¸æ‡‚çš„å¯ä»¥å†çœ‹ä¸€éï¼Œå¾ˆå®¹æ˜“ç†è§£çš„å“¦ï½ã€‚

æœ€åæˆ‘æƒ³è¯´çš„æ˜¯ï¼š`channel`å†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨äº’æ–¥é”ï¼Œé‚£ä¹ˆ`channel`å’Œäº’æ–¥é”è°æ›´è½»é‡å‘¢ï¼Ÿï¼ˆ**è¯„è®ºåŒºæˆ‘ä»¬ä¸€èµ·æ¢è®¨ä¸€ä¸‹**ï¼‰ã€‚

**ç´ è´¨ä¸‰è¿ï¼ˆåˆ†äº«ã€ç‚¹èµã€åœ¨çœ‹ï¼‰éƒ½æ˜¯ç¬”è€…æŒç»­åˆ›ä½œæ›´å¤šä¼˜è´¨å†…å®¹çš„åŠ¨åŠ›ï¼æˆ‘æ˜¯`asong`ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ã€‚**

**åˆ›å»ºäº†ä¸€ä¸ªGolangå­¦ä¹ äº¤æµç¾¤ï¼Œæ¬¢è¿å„ä½å¤§ä½¬ä»¬è¸Šè·ƒå…¥ç¾¤ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº¤æµã€‚å…¥ç¾¤æ–¹å¼ï¼šå…³æ³¨å…¬ä¼—å·è·å–ã€‚æ›´å¤šå­¦ä¹ èµ„æ–™è¯·åˆ°å…¬ä¼—å·é¢†å–ã€‚**

![æ‰«ç _æœç´¢è”åˆä¼ æ’­æ ·å¼-ç™½è‰²ç‰ˆ](https://song-oss.oss-cn-beijing.aliyuncs.com/golang_dream/article/static/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E7%99%BD%E8%89%B2%E7%89%88.png)

æ¨èå¾€æœŸæ–‡ç« ï¼š

- [Goè¯­è¨€å¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿ](https://mp.weixin.qq.com/s/S_EzyWZmFzzbBbxoSNe6Hw)
- [Goè¯­è¨€ä¸­newå’Œmakeä½ ä½¿ç”¨å“ªä¸ªæ¥åˆ†é…å†…å­˜ï¼Ÿ](https://mp.weixin.qq.com/s/xNdnVXxC5Ji2ApgbfpRaXQ)
- [æºç å‰–æpanicä¸recoverï¼Œçœ‹ä¸æ‡‚ä½ æ‰“æˆ‘å¥½äº†ï¼](https://mp.weixin.qq.com/s/yJ05a6pNxr_G72eiWTJ-rw)
- [ç©ºç»“æ„ä½“å¼•å‘çš„å¤§å‹æ‰“è„¸ç°åœº](https://mp.weixin.qq.com/s/aHwGWWmnDFkcw2cyw5jmgw)
- [Leafâ€”Segmentåˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿï¼ˆGolangå®ç°ç‰ˆæœ¬ï¼‰](https://mp.weixin.qq.com/s/UJKBHm58TXi37v53iZP8xA)
- [é¢è¯•å®˜ï¼šä¸¤ä¸ªnilæ¯”è¾ƒç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ](https://mp.weixin.qq.com/s/CNOLLLRzHomjBnbZMnw0Gg)
- [é¢è¯•å®˜ï¼šä½ èƒ½ç”¨Goå†™æ®µä»£ç åˆ¤æ–­å½“å‰ç³»ç»Ÿçš„å­˜å‚¨æ–¹å¼å—?](https://mp.weixin.qq.com/s/DWMqzOi7wf79DoUUAJnr1w)
- [é¢è¯•ä¸­å¦‚æœè¿™æ ·å†™äºŒåˆ†æŸ¥æ‰¾](https://mp.weixin.qq.com/s/z7NIzrcVRhpoLUQdFAa8JQ)

